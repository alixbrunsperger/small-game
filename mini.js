ctx=canvas.getContext("2d"),canvas_rect={},(onresize=function(){canvas.className=innerWidth<16*innerHeight/9?"portrait":"landscape",canvas_rect=canvas.getBoundingClientRect()})();var enemy_w=32,enemy_h=32,uright=[1,0],ubottom=[0,1],uL1=[-16,-16],uC1=[0,-16],uR1=[16,-16],uL2=[-16,0],uR2=[16,0],uL3=[-16,8],uC3=[0,16],uR3=[16,8],uL4=[-16,16],uR4=[16,16],uL5=[-8,16],uR5=[8,16];base_vectors={right:uright,bottom:ubottom},vectors={L1:uL1,C1:uC1,R1:uR1,L2:uL2,R2:uR2,L3:uL3,C3:uC3,R3:uR3,L4:uL4,R4:uR4,L5:uL5,R5:uR5};var rotate_ennemies=function(a,b){for(var c in a.angle=b*Math.PI/180,base_vectors)a[c]=[base_vectors[c][0]*Math.cos(a.angle)-base_vectors[c][1]*Math.sin(a.angle),base_vectors[c][0]*Math.sin(a.angle)+base_vectors[c][1]*Math.cos(a.angle)];for(var c in vectors)a[c]=[vectors[c][0]*a.right[0]+vectors[c][1]*a.bottom[0],vectors[c][0]*a.right[1]+vectors[c][1]*a.bottom[1]]},move_ennemies=function(a){a.x>hero.x?(a.walk_speed-=a.walk_acceleration,a.walk_speed<-a.max_walk_speed&&(a.walk_speed=-a.max_walk_speed)):a.x<hero.x?(a.walk_speed+=a.walk_acceleration,a.walk_speed>a.max_walk_speed&&(a.walk_speed=a.max_walk_speed)):1>Math.abs(a.walk_speed)?a.walk_speed=0:0<a.walk_speed?a.walk_speed+=a.walk_idle_deceleration:0>a.walk_speed&&(a.walk_speed-=a.walk_idle_deceleration);for(var b=0;b<Math.abs(a.walk_speed)*frametime_coef;b++)if(a.x+=a.right[0]*Math.sign(a.walk_speed),a.y+=a.right[1]*Math.sign(a.walk_speed),0<a.walk_speed){if(!is_solid(a.x+a.R1[0]+-3*a.bottom[0],a.y+a.R1[1]+-3*a.bottom[1])&&!is_solid(a.x+a.C1[0],a.y+a.C1[1])&&!is_solid(a.x+a.L1[0],a.y+a.L1[1])&&!is_solid(a.x+a.R2[0],a.y+a.R2[1])&&!is_solid(a.x+a.R3[0],a.y+a.R3[1]))for(var c=0;4>c;c++)if(is_solid(a.x+a.R4[0]+-c*a.bottom[0],a.y+a.R4[1]+-c*a.bottom[1])){a.x+=4*-a.bottom[0],a.y+=4*-a.bottom[1];break}if(is_solid(a.x+a.R1[0],a.y+a.R1[1])||is_solid(a.x+a.R2[0],a.y+a.R2[1])||is_solid(a.x+a.R3[0],a.y+a.R3[1])){a.walk_speed=0,a.x-=a.right[0],a.y-=a.right[1];break}}else if(0>a.walk_speed){if(!is_solid(a.x+a.L1[0]+-3*a.bottom[0],a.y+a.L1[1]+-3*a.bottom[1])&&!is_solid(a.x+a.C1[0],a.y+a.C1[1])&&!is_solid(a.x+a.R1[0],a.y+a.R1[1])&&!is_solid(a.x+a.L2[0],a.y+a.L2[1])&&!is_solid(a.x+a.L3[0],a.y+a.L3[1]))for(var c=0;4>c;c++)if(is_solid(a.x+a.L4[0]+-c*a.bottom[0],a.y+a.L4[1]+-c*a.bottom[1])){a.x+=4*-a.bottom[0],a.y+=4*-a.bottom[1];break}if(is_solid(a.x+a.L1[0],a.y+a.L1[1])||is_solid(a.x+a.L2[0],a.y+a.L2[1])||is_solid(a.x+a.L3[0],a.y+a.L3[1])){a.walk_speed=0,a.x-=-a.right[0],a.y-=-a.right[1];break}}a.fall_speed+=a.gravity,a.fall_speed>a.max_fall_speed&&(a.fall_speed=a.max_fall_speed),l1.value=a.fall_speed;mv:for(var b=0;b<Math.abs(a.fall_speed)*frametime_coef;b++)if(a.x+=a.bottom[0]*Math.sign(a.fall_speed),a.y+=a.bottom[1]*Math.sign(a.fall_speed),0<a.fall_speed){for(var c=0;c<enemy_w;c++)if(is_solid(a.x+a.L4[0]+c*a.right[0],a.y+a.L4[1]+c*a.right[1])){a.fall_speed=0,a.x-=a.bottom[0],a.y-=a.bottom[1],a.freefall=!1;break mv}}else if(0>a.fall_speed&&(is_solid(a.x+a.L1[0],a.y+a.L1[1])||is_solid(a.x+a.C1[0],a.y+a.C1[1])||is_solid(a.x+a.R1[0],a.y+a.R1[1]))){a.fall_speed=0,a.x-=-a.bottom[0],a.y-=-a.bottom[1];break}};switchEnemySprite=a=>{a.current_sprite=a.current_sprite===a.sprite?a.alternate_sprite:a.sprite},collision_enemy=function(a){var b={r1:{x:hero.x+hero.R1[0],y:hero.y+hero.R1[1]},r4:{x:hero.x+hero.R4[0],y:hero.y+hero.R4[1]},l1:{x:hero.x+hero.L1[0],y:hero.y+hero.L1[1]},l4:{x:hero.x+hero.L4[0],y:hero.y+hero.L4[1]}},c={r1:{x:a.x+a.R1[0],y:a.y+a.R1[1]},r4:{x:a.x+a.R4[0],y:a.y+a.R4[1]},l1:{x:a.x+a.L1[0],y:a.y+a.L1[1]},l4:{x:a.x+a.L4[0],y:a.y+a.L4[1]}};return collide(b,c)},attack_enemy=function(a){var b={r1:{x:hero.x+5,y:hero.y-6},r4:{x:hero.x+5+16,y:hero.y-6},l1:{x:hero.x+5+16,y:hero.y+16},l4:{x:hero.x+5,y:hero.y+16}},c={r1:{x:a.x+a.R1[0],y:a.y+a.R1[1]},r4:{x:a.x+a.R4[0],y:a.y+a.R4[1]},l1:{x:a.x+a.L1[0],y:a.y+a.L1[1]},l4:{x:a.x+a.L4[0],y:a.y+a.L4[1]}};return collide(b,c)},collide=function(a,b){return a.r1.x>=b.l1.x&&a.r1.x<=b.r1.x&&a.r1.y>=b.l1.y&&a.r1.y<=b.l4.y||a.r4.x>=b.l1.x&&a.r4.x<=b.r1.x&&a.r4.y>=b.l1.y&&a.r4.y<=b.l4.y||a.l1.x>=b.l1.x&&a.l1.x<=b.r1.x&&a.l1.y>=b.l1.y&&a.l1.y<=b.l4.y||a.l4.x>=b.l1.x&&a.l4.x<=b.r1.x&&a.l4.y>=b.l1.y&&a.l4.y<=b.l4.y},update_monster=function(a){0<a.timer_hit&&(a.timer_hit=hero.timer_hit-1)},isMonsterTouched=function(a){return 0<a.timer_hit},create_enemy=(a,b,c)=>{var d="",f="",g=0,h=1,k=2;return"basic"===c?(d=monster,f=monster2,g=1,k=0.2):"flying"===c?(d=flying,f=flying2,g=1,h=0):"boss"===c?(d=boss,f=boss2,g=5,k=0.1):void 0,{x:a,y:b,sprite:d,alternate_sprite:f,current_sprite:d,type:c,angle:0,right:[],bottom:[],width:32,height:32,L1:[],C1:[],R1:[],L2:[],R2:[],L3:[],C3:[],R3:[],L4:[],R4:[],L5:[],R5:[],max_walk_speed:k,walk_acceleration:0.2,walk_idle_deceleration:-1,jump_speed:-14,gravity:h,walk_speed:0,fall_speed:0,max_fall_speed:6,hp:g,current_hp:g,freefall:"flying"!==c}},enemies=[],enemies[0]=[],enemies[1]=[create_enemy(650,401,"basic")],enemies[2]=[create_enemy(340,370,"basic"),create_enemy(650,201,"flying")],enemies[3]=[create_enemy(340,370,"basic"),create_enemy(700,270,"basic"),create_enemy(650,201,"flying")],enemies[4]=[create_enemy(402,370,"basic"),create_enemy(700,271,"basic"),create_enemy(600,201,"flying"),create_enemy(650,251,"flying")],enemies[5]=[create_enemy(256,340,"basic"),create_enemy(462,370,"basic"),create_enemy(700,401,"basic")],enemies[6]=[create_enemy(650,401,"boss")],enemies[7]=[];var prev_time=+new Date,time=0,frametime=0,normal_frametime=16,frametime_coef=0,total_frames=0,up=1,right=1,invertUp=1,invertRight=1;game=function(){for(i in time=+new Date,frametime=time-prev_time,prev_time=time,frametime_coef=frametime/normal_frametime,++total_frames,end||move_hero(),canvas.width=canvas.width,ctx.fillStyle="black",maps[current_map])for(j in maps[current_map][i])"0"!=maps[current_map][i][j]&&ctx.drawImage(tiles[maps[current_map][i][j]].sprite,j*tile_w,i*tile_h,tile_w,tile_h);ctx.save(),ctx.fillStyle="red",ctx.fillRect(hero.x-20,hero.y-25,40,5),ctx.fillStyle="green",ctx.fillRect(hero.x-20,hero.y-25,40*hero.current_hp/hero.hp,5),ctx.translate(hero.x,hero.y),ctx.save(),isHeroTouched()&&(ctx.globalAlpha=0.4),ctx.drawImage(hero_sprite,-16,-16,tile_w,tile_h),ctx.restore(),keys.attack?ctx.drawImage(keyboard_sprite2,5,0,16,16):ctx.drawImage(keyboard_sprite,5,-6,16,16),enemies[current_map].forEach(a=>{rotate_ennemies(a,0),0==total_frames%10&&switchEnemySprite(a),move_ennemies(a),ctx.restore(),isMonsterTouched(a)&&(ctx.globalAlpha=0.4),ctx.drawImage(a.current_sprite,a.x-16,a.y-16,a.width,a.height),ctx.fillStyle="red",ctx.fillRect(a.x-20,a.y-25,40,5),ctx.fillStyle="green",ctx.fillRect(a.x-20,a.y-25,40*a.current_hp/a.hp,5),!isHeroTouched()&&collision_enemy(a)&&(--hero.current_hp,hero.timer_hit=50),keys.attack&&attack_enemy(a)&&!isMonsterTouched(a)&&(--a.current_hp,0>=a.current_hp?enemies[current_map].splice(enemies[current_map].indexOf(a),1):a.timer_hit=50),update_monster(a)}),update_hero(),ctx.restore(),texts[current_map].forEach(a=>{ctx.font="20px Arial",ctx.fillStyle="black",ctx.textAlign="center",ctx.fillText(a,canvas.width/2,50*(texts[current_map].indexOf(a)+1))},texts[current_map]),l3.value=hero.x+" "+hero.y+" "+current_map,hero.x>24*tile_w&&(6!==current_map||0===enemies[current_map].length)&&change_step(!0),hero.x<tile_w&&change_step(!1),0>=hero.current_hp?(ctx.font="20px Arial",ctx.fillStyle="red",ctx.fillText("You're dead! Refresh the page to start again",150,250)):end&&(invertUp=0==up||300==up?-invertUp:invertUp,invertRight=0==right||20==right?-invertRight:invertRight,up+=1*invertUp,right+=1*invertRight,ctx.drawImage(nyancat,canvas.width/2-150+up,canvas.height/2-10+right,32,32)),requestAnimationFrame(game)},onload=function(){rotate_hero(0),game()};var hero_w=22,hero_h=28,uright=[1,0],ubottom=[0,1],uL1=[-11,-14],uC1=[0,-14],uR1=[11,-14],uL2=[-11,0],uR2=[11,0],uL3=[-11,8],uC3=[0,14],uR3=[11,8],uL4=[-11,14],uR4=[11,14],uL5=[-7,14],uR5=[7,14];base_vectors={right:uright,bottom:ubottom},vectors={L1:uL1,C1:uC1,R1:uR1,L2:uL2,R2:uR2,L3:uL3,C3:uC3,R3:uR3,L4:uL4,R4:uR4,L5:uL5,R5:uR5};var hero={x:50,y:401,angle:0,right:[],bottom:[],L1:[],C1:[],R1:[],L2:[],R2:[],L3:[],C3:[],R3:[],L4:[],R4:[],L5:[],R5:[],max_walk_speed:3,walk_acceleration:0.3,walk_idle_deceleration:-1,jump_speed:-14,gravity:1,walk_speed:0,fall_speed:0,max_fall_speed:6,hp:10,current_hp:10,damage:1,timer_attack:0,timer_hit:0,freefall:!0},rotate_hero=function(a){for(var b in hero.angle=a*Math.PI/180,base_vectors)hero[b]=[base_vectors[b][0]*Math.cos(hero.angle)-base_vectors[b][1]*Math.sin(hero.angle),base_vectors[b][0]*Math.sin(hero.angle)+base_vectors[b][1]*Math.cos(hero.angle)];for(var b in vectors)hero[b]=[vectors[b][0]*hero.right[0]+vectors[b][1]*hero.bottom[0],vectors[b][0]*hero.right[1]+vectors[b][1]*hero.bottom[1]]},move_hero=function(){keys.left&&!keys.right?(hero.walk_speed-=hero.walk_acceleration,hero.walk_speed<-hero.max_walk_speed&&(hero.walk_speed=-hero.max_walk_speed)):keys.right&&!keys.left?(hero.walk_speed+=hero.walk_acceleration,hero.walk_speed>hero.max_walk_speed&&(hero.walk_speed=hero.max_walk_speed)):1>Math.abs(hero.walk_speed)?hero.walk_speed=0:0<hero.walk_speed?hero.walk_speed+=hero.walk_idle_deceleration:0>hero.walk_speed&&(hero.walk_speed-=hero.walk_idle_deceleration);for(var a=0;a<Math.abs(hero.walk_speed)*frametime_coef;a++)if(hero.x+=hero.right[0]*Math.sign(hero.walk_speed),hero.y+=hero.right[1]*Math.sign(hero.walk_speed),0<hero.walk_speed){if(!is_solid(hero.x+hero.R1[0]+-3*hero.bottom[0],hero.y+hero.R1[1]+-3*hero.bottom[1])&&!is_solid(hero.x+hero.C1[0],hero.y+hero.C1[1])&&!is_solid(hero.x+hero.L1[0],hero.y+hero.L1[1])&&!is_solid(hero.x+hero.R2[0],hero.y+hero.R2[1])&&!is_solid(hero.x+hero.R3[0],hero.y+hero.R3[1]))for(var b=0;4>b;b++)if(is_solid(hero.x+hero.R4[0]+-b*hero.bottom[0],hero.y+hero.R4[1]+-b*hero.bottom[1])){hero.x+=4*-hero.bottom[0],hero.y+=4*-hero.bottom[1];break}if(is_solid(hero.x+hero.R1[0],hero.y+hero.R1[1])||is_solid(hero.x+hero.R2[0],hero.y+hero.R2[1])||is_solid(hero.x+hero.R3[0],hero.y+hero.R3[1])){hero.walk_speed=0,hero.x-=hero.right[0],hero.y-=hero.right[1];break}}else if(0>hero.walk_speed){if(!is_solid(hero.x+hero.L1[0]+-3*hero.bottom[0],hero.y+hero.L1[1]+-3*hero.bottom[1])&&!is_solid(hero.x+hero.C1[0],hero.y+hero.C1[1])&&!is_solid(hero.x+hero.R1[0],hero.y+hero.R1[1])&&!is_solid(hero.x+hero.L2[0],hero.y+hero.L2[1])&&!is_solid(hero.x+hero.L3[0],hero.y+hero.L3[1]))for(var b=0;4>b;b++)if(is_solid(hero.x+hero.L4[0]+-b*hero.bottom[0],hero.y+hero.L4[1]+-b*hero.bottom[1])){hero.x+=4*-hero.bottom[0],hero.y+=4*-hero.bottom[1];break}if(is_solid(hero.x+hero.L1[0],hero.y+hero.L1[1])||is_solid(hero.x+hero.L2[0],hero.y+hero.L2[1])||is_solid(hero.x+hero.L3[0],hero.y+hero.L3[1])){hero.walk_speed=0,hero.x-=-hero.right[0],hero.y-=-hero.right[1];break}}keys.up&&!hero.freefall&&(hero.freefall=!0,hero.fall_speed+=hero.jump_speed),hero.fall_speed+=hero.gravity,hero.fall_speed>hero.max_fall_speed&&(hero.fall_speed=hero.max_fall_speed),l1.value=hero.fall_speed;mv:for(var a=0;a<Math.abs(hero.fall_speed)*frametime_coef;a++)if(hero.x+=hero.bottom[0]*Math.sign(hero.fall_speed),hero.y+=hero.bottom[1]*Math.sign(hero.fall_speed),0<hero.fall_speed){for(var b=0;b<hero_w;b++)if(is_solid(hero.x+hero.L4[0]+b*hero.right[0],hero.y+hero.L4[1]+b*hero.right[1])){hero.fall_speed=0,hero.x-=hero.bottom[0],hero.y-=hero.bottom[1],hero.freefall=!1;break mv}}else if(0>hero.fall_speed&&(is_solid(hero.x+hero.L1[0],hero.y+hero.L1[1])||is_solid(hero.x+hero.C1[0],hero.y+hero.C1[1])||is_solid(hero.x+hero.R1[0],hero.y+hero.R1[1]))){hero.fall_speed=0,hero.x-=-hero.bottom[0],hero.y-=-hero.bottom[1];break}};isHeroTouched=function(){return 0<hero.timer_hit},update_hero=function(){0<hero.timer_hit&&--hero.timer_hit,!0===keys.attack&&++hero.timer_attack};keys={left:!1,up:!1,top:!1,attack:!1},onkeydown=onkeypress=function(a){switch(a.keyCode){case 32:keys.attack=1>hero.timer_attack;break;case 37:keys.left=!0;break;case 38:keys.up=!0;break;case 39:keys.right=!0;}},onkeyup=function(a){switch(a.keyCode){case 32:hero.timer_attack=0,keys.attack=!1;break;case 37:keys.left=!1;break;case 38:keys.up=!1;break;case 39:keys.right=!1;}};maps=[];var end=!1;maps[0]=["0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","1111111111111111111111111"],maps[1]=["0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000011111000000000000000","1111111111111111111111111"],maps[2]=["0000444444444444444444444","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","1111100000000000000000000","2222222000000000000000000","2222222222000000000000000","2222222222220000000000000","2222222222222222222222222"],maps[3]=["4444444444444444444440000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000011111","0000000000000000002222222","0000000000000002222222222","0000000000000222222222222","2222222222222222222222222"],maps[4]=["0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000033333","0000000000000000003333333","0000000000000003333333333","0000000033333333333333333","1111111333333333333333333"],maps[5]=["0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","3333300000000000000000000","3333333000000000000000000","3333333333000000000000000","3333333333333333300000000","3333333333333333331111111"],maps[6]=["0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","1111111111111111111111111"],maps[7]=["0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","0000000000000000000000000","1111111111111111111111111"],current_map=0,change_step=a=>{switch(current_map){case 0:a&&(++current_map,hero.x=73,hero.y=401,move_hero());break;case 1:current_map=a?current_map+1:current_map-1,hero.x=a?73:680,hero.y=a?273:401,move_hero();break;case 2:current_map=a?current_map+1:current_map-1,hero.x=a?73:680,hero.y=a?401:401,move_hero();break;case 3:current_map=a?current_map+1:current_map-1,hero.x=a?73:680,hero.y=a?401:401,move_hero();break;case 4:current_map=a?current_map+1:current_map-1,hero.x=a?73:680,hero.y=a?273:273,move_hero();break;case 5:current_map=a?current_map+1:current_map-1,hero.x=a?73:680,hero.y=a?401:273,move_hero();break;case 6:current_map=a?current_map+1:current_map-1,hero.x=a?73:680,hero.y=a?401:401,move_hero(),end=!0;break;case 7:}};texts=[],texts[0]=["The source of Internet has been stolen ! Everyone is offline !","You have to fix that! Take your keyboard and go !","(use arrows to move, and space to attack)"],texts[1]=[],texts[2]=[],texts[3]=[],texts[4]=[],texts[5]=[],texts[6]=[],texts[7]=["You have freed the source of Internet: the nyancat !","Thanks for playing :)"];tile_w=32,tile_h=32,tiles={0:{sprite:void_sprite,solid:0},1:{sprite:ground_tile1,solid:1},2:{sprite:ground_tile2,solid:1},3:{sprite:ground_tile3,solid:1},4:{sprite:ceiling_tile,solid:1}},is_solid=function(a,b){var c=Math.floor(b/tile_h);if(!maps[current_map][c])return!1;var d=Math.floor(a/tile_w);return!!maps[current_map][c][d]&&0!==tiles[maps[current_map][c][d]].solid&&(!(1!==tiles[maps[current_map][c][d]].solid)||void 0)};